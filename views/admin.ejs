<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Disaster Alerts</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0f1419; --surface:#1c232b; --border:#2b3540; --text:#f5f7fa; --accent:#6366f1; --radius:14px; --danger:#ef4444; --warn:#f59e0b; --ok:#10b981; }
    body { margin:0; font:500 14px/1.4 'Inter',system-ui; background:var(--bg); color:var(--text); display:flex; min-height:100vh; }
    header { padding:1rem 1.25rem; background:var(--surface); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; }
    h1 { margin:0; font-size:1rem; letter-spacing:.05em; }
    main { flex:1; padding:1.25rem; display:grid; gap:1.4rem; max-width:1200px; margin:0 auto; width:100%; }
    section { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:1.2rem 1.2rem 1.4rem; display:flex; flex-direction:column; gap:.9rem; }
    .row { display:flex; gap:.8rem; flex-wrap:wrap; }
    label { font-size:.65rem; text-transform:uppercase; letter-spacing:.08em; font-weight:600; opacity:.8; display:block; margin-bottom:.35rem; }
    input, select, textarea { background:#12181f; border:1px solid var(--border); color:var(--text); padding:.6rem .7rem; border-radius:10px; font:500 .8rem 'Inter'; width:100%; resize:vertical; }
    input:focus, select:focus, textarea:focus { outline:none; border-color:var(--accent); }
    form { display:flex; flex-direction:column; gap:1rem; }
    button { cursor:pointer; font:600 .7rem 'Inter'; letter-spacing:.05em; padding:.75rem 1rem; border-radius:10px; border:1px solid var(--accent); background:var(--accent); color:#fff; display:inline-flex; gap:.45rem; align-items:center; }
    button.secondary { background:transparent; color:var(--text); border-color:var(--border); }
    button.secondary:hover { border-color:var(--accent); }
    button:hover { filter:brightness(1.1); }
    .alerts-table { width:100%; border-collapse:collapse; font-size:.7rem; }
    .alerts-table th, .alerts-table td { border-bottom:1px solid var(--border); padding:.55rem .6rem; text-align:left; }
    .badge { padding:.25rem .5rem; border-radius:20px; font-size:.6rem; font-weight:600; letter-spacing:.05em; }
    .sev-info { background:#374151; }
    .sev-low { background:#2563eb; }
    .sev-moderate { background:#d97706; }
    .sev-high { background:#dc2626; }
    .sev-critical { background:#7f1d1d; }
    .type-pill { background:#334155; }
    footer { margin-top:auto; padding:1rem; font-size:.6rem; opacity:.6; text-align:center; }
    .status { font-size:.65rem; min-height:1.2rem; }
    .flex { display:flex; gap:.6rem; align-items:center; }
    .grow { flex:1; }
    .danger { color:var(--danger); }
    .success { color:var(--ok); }
    .filters { display:flex; gap:.6rem; flex-wrap:wrap; }
  </style>
</head>
<body>
  <header>
    <h1>Disaster Alert Admin</h1>
    <div class="flex">
      <a href="/dashboard" style="text-decoration:none;color:var(--text);font-size:.65rem;">‚Üê Back to Dashboard</a>
    </div>
  </header>
  <main>
    <section>
      <h2 style="margin:0;font-size:.85rem;">Create Alert</h2>
      <form id="alertForm">
        <div class="row">
          <div style="flex:1;min-width:140px;">
            <label>Pincode</label>
            <input name="pincode" maxlength="6" pattern="\d{6}" required placeholder="6-digit" />
          </div>
          <div style="flex:1;min-width:160px;">
            <label>Type</label>
            <select name="type" required>
              <option value="earthquake">Earthquake</option>
              <option value="flood">Flood</option>
              <option value="fire">Fire</option>
              <option value="cyclone">Cyclone</option>
              <option value="landslide">Landslide</option>
              <option value="pandemic">Pandemic</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div style="flex:1;min-width:160px;">
            <label>Severity</label>
            <select name="severity">
              <option value="info">Info</option>
              <option value="low">Low</option>
              <option value="moderate">Moderate</option>
              <option value="high">High</option>
              <option value="critical">Critical</option>
            </select>
          </div>
        </div>
        <div>
          <label>Message (optional)</label>
          <textarea name="message" rows="3" placeholder="Context / instructions"></textarea>
        </div>
        <div class="flex">
          <div class="status" id="formStatus"></div>
          <div class="grow"></div>
          <button type="submit">Publish Alert</button>
        </div>
      </form>
    </section>

    <section>
      <h2 style="margin:0;font-size:.85rem;">Recent Alerts</h2>
      <div class="filters">
        <input id="filterPincode" placeholder="Filter pincode" style="max-width:140px;" />
        <select id="filterType" style="max-width:140px;">
          <option value="">All Types</option>
          <option value="earthquake">Earthquake</option>
          <option value="flood">Flood</option>
          <option value="fire">Fire</option>
          <option value="cyclone">Cyclone</option>
          <option value="landslide">Landslide</option>
          <option value="pandemic">Pandemic</option>
          <option value="other">Other</option>
        </select>
        <button class="secondary" id="refreshBtn" type="button">Refresh</button>
      </div>
      <table class="alerts-table" id="alertsTable">
        <thead>
          <tr>
            <th>Time</th>
            <th>Pincode</th>
            <th>Type</th>
            <th>Severity</th>
            <th>Message</th>
          </tr>
        </thead>
        <tbody id="alertsBody">
          <% if(alerts && alerts.length){ alerts.forEach(a => { %>
            <tr>
              <td><%= new Date(a.createdAt).toLocaleString() %></td>
              <td><%= a.pincode %></td>
              <td><span class="badge type-pill"><%= a.type %></span></td>
              <td><span class="badge sev-<%= a.severity %>"><%= a.severity %></span></td>
              <td><%= a.message %></td>
            </tr>
          <% }) } else { %>
            <tr><td colspan="5" style="opacity:.5;">No alerts yet</td></tr>
          <% } %>
        </tbody>
      </table>
    </section>
  </main>
  <footer>&copy; <%= new Date().getFullYear() %> ResQverse Admin</footer>
  <script>
    const form = document.getElementById('alertForm');
    const statusEl = document.getElementById('formStatus');
    const bodyEl = document.getElementById('alertsBody');
    const filterPincode = document.getElementById('filterPincode');
    const filterType = document.getElementById('filterType');
    const refreshBtn = document.getElementById('refreshBtn');

    function badgeClass(sev){ return 'badge sev-' + (sev || 'info'); }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      statusEl.textContent = 'Publishing...'; statusEl.className='status';
      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());
      try {
        const res = await fetch('/admin/alerts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        if(!data.success) throw new Error(data.message || 'Failed');
        statusEl.textContent = 'Published'; statusEl.classList.add('success');
        // Prepend row
        const a = data.alert;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(a.createdAt).toLocaleString()}</td><td>${a.pincode}</td><td><span class='badge type-pill'>${a.type}</span></td><td><span class='${badgeClass(a.severity)}'>${a.severity}</span></td><td>${(a.message||'')}</td>`;
        bodyEl.prepend(tr);
        form.reset();
        setTimeout(()=> statusEl.textContent='', 2500);
      } catch (err) {
        statusEl.textContent = err.message; statusEl.classList.add('danger');
      }
    });

    async function loadAlerts(){
      const q = new URLSearchParams();
      if(filterPincode.value && /^\d{6}$/.test(filterPincode.value)) q.set('pincode', filterPincode.value);
      // For now type filtering client-side after fetch; could add server param
      const res = await fetch('/api/alerts?' + q.toString());
      const data = await res.json();
      let alerts = data.alerts || [];
      if(filterType.value) alerts = alerts.filter(a => a.type === filterType.value);
      bodyEl.innerHTML = alerts.length ? alerts.map(a => `<tr><td>${new Date(a.createdAt).toLocaleString()}</td><td>${a.pincode}</td><td><span class='badge type-pill'>${a.type}</span></td><td><span class='${badgeClass(a.severity)}'>${a.severity}</span></td><td>${a.message||''}</td></tr>`).join('') : `<tr><td colspan='5' style='opacity:.5;'>No alerts found</td></tr>`;
    }

    refreshBtn.addEventListener('click', loadAlerts);
    filterType.addEventListener('change', loadAlerts);
    filterPincode.addEventListener('keyup', (e)=> { if(e.key==='Enter') loadAlerts(); });
  </script>
</body>
</html>
